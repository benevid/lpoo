![](https://tva1.sinaimg.cn/large/006y8mN6gy1g73dk4h33oj30ss0g8jrr.jpg)

# Aplicativos m√≥veis para a Internet 

Este guia apresenta tudo que voc√™ precisa para come√ßar a criar aplicativos m√≥veis para a Internet das Coisas em JavaScript/HTML usando o Evothings Studio.  No entanto, existem outras ferramentas similares que voc√™ pode utilizar para desenvolver aplica√ß√µes de forma similar:

- https://phonegap.com ‚úÖ
- [https://thunkable.com](https://thunkable.com/) üöº
- http://appinventor.mit.edu/ üí§

> 

### Etapas para conectar-se a um dispositivo BLE

Para conectar-se a um dispositivo BLE e come√ßar a ler/gravar dados, tem-se as seguintes etapas:

1. üïµüèª‚Äç‚ôÇÔ∏è Procurar pelo dispositivo 
2. üì° Conectar-se ao dispositivo
3. üìù Ler e Gravar Caracter√≠sticas

> ‚òïÔ∏é Uma caracter√≠stica √© como um comando ou fun√ß√£o, √© um local que voc√™ l√™ ou escreve para buscar dados ou controlar o dispositivo (ligar ou desligar um LED ou um motor, por exemplo). **Servi√ßos** s√£o cole√ß√µes de caracter√≠sticas, agrupam comandos/fun√ß√µes relacionados.

O que voc√™ precisa saber para programar um dispositivo BLE s√£o os **UUIDs** dos servi√ßos e **caracter√≠sticas** que voc√™ deseja usar. Essas informa√ß√µes geralmente s√£o encontradas na documenta√ß√£o do fabricante do dispositivo. 

> ‚òïÔ∏é Os UUIDs ser√£o colocados no c√≥digo ao fazer chamadas para as fun√ß√µes da biblioteca BLE. 

![img](https://i2.wp.com/randomnerdtutorials.com/wp-content/uploads/2018/06/GATT-BLE-ESP32.png?w=813&ssl=1)

O n√≠vel superior da hierarquia √© um perfil, composto por um ou mais servi√ßos. Normalmente, um dispositivo BLE cont√©m mais de um servi√ßo. Todo servi√ßo cont√©m pelo menos uma caracter√≠stica ou tamb√©m pode fazer refer√™ncia a outros servi√ßos. Um servi√ßo √© simplesmente uma cole√ß√£o de informa√ß√µes, como leituras de sensores, por exemplo. Existem servi√ßos predefinidos para v√°rios tipos de dados definidos pelo SIG (Bluetooth Special Interest Group), como: 

- N√≠vel da bateria
- Press√£o arterial
- Freq√º√™ncia card√≠aca
- Escala de peso, etc.

A **caracter√≠stica** sempre pertence a um servi√ßo e √© onde os dados reais est√£o contidos na hierarquia (valor). A caracter√≠stica sempre tem dois atributos: declara√ß√£o da caracter√≠stica (que fornece metadados sobre os dados) e o valor da caracter√≠stica.

Al√©m disso, o valor da caracter√≠stica pode ser seguido por **descritores**, que expandem ainda mais os metadados contidos na declara√ß√£o da caracter√≠stica. 

As **propriedades** descrevem como o valor da caracter√≠stica pode ser interagido. Basicamente, cont√©m as opera√ß√µes e procedimentos que podem ser usados com a caracter√≠stica:

- Difus√£o
- Ler
- Escreva sem resposta
- Escreva
- Notificar
- Indicar
- Grava√ß√µes assinadas autenticadas
- Propriedades estendidas

Cada servi√ßo, caracter√≠stica e descritor possui um UUID (Universally Unique Identifier). Um UUID √© um n√∫mero exclusivo de 128 bits (16 bytes). Por exemplo:

```
55072829-bc9e-4c53-938a-74a6d4c78776
```

Existem UUIDs reduzidos para todos os tipos, servi√ßos e perfis especificados no SIG (Bluetooth Special Interest Group). Em resumo, o UUID √© usado para identificar informa√ß√µes exclusivamente. Por exemplo, ele pode identificar um servi√ßo espec√≠fico fornecido por um dispositivo Bluetooth.

### Como falar com um dispositivo BLE - servi√ßos e caracter√≠sticas

Um dispositivo BLE exp√µe sua interface de comunica√ß√£o atrav√©s de servi√ßos e caracter√≠sticas. Um **servi√ßo** pode ter uma ou mais **caracter√≠sticas**. Cada **caracter√≠stica** tamb√©m pode ter um ou mais descritores (os descritores tendem a ser acessados com menos frequ√™ncia pelo c√≥digo do aplicativo).

```markdown
A[Servi√ßo] -> B(Caracter√≠stica)
D(Caracter√≠stica) --> C{Descritores}
```

Por exemplo: um **term√¥metro** habilitado para BLE geralmente possui um servi√ßo de temperatura com uma caracter√≠stica que permite ler a temperatura.

![](https://tva1.sinaimg.cn/large/006y8mN6gy1g73e0xelfjj30bt05vmx9.jpg)

Cada **servi√ßo** e **caracter√≠stica** tem um ID **universalmente exclusivo** (UUID), que s√£o utilizados para configurar a comunica√ß√£o com o dispositivo BLE a partir do JavaScript. Os UUIDs geralmente s√£o encontrados na documenta√ß√£o do dispositivo fornecida pelo fabricante.

Cada dispositivos BLE pode ter servi√ßos e caracter√≠sticas diferentes, mas o princ√≠pio geral √© o mesmo. Alguns dispositivos t√™m op√ß√µes para configur√°-lo, outros podem n√£o precisar de nenhuma configura√ß√£o espec√≠fica. Em alguns dispositivos voc√™ l√™ principalmente dados (como um term√¥metro), em outros, voc√™ grava dados neles (como m√°quinas controladas remotamente).

Veja um exemplo do **O ESP32** do curso possui os seguintes UUIDs:

```
SERVICE_UUID        "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
CHARACTERISTIC_UUID_RX "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
CHARACTERISTIC_UUID_TX "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"
```

Esses UUIDs s√£o usados no c√≥digo de exemplo mostrado abaixo. Use os UUIDs para os servi√ßos e as caracter√≠sticas do dispositivo com o qual voc√™ est√° trabalhando no seu c√≥digo de aplicativo real.

### Debugando no Evothings Studio

Nos exemplos de c√≥digo abaixo, a fun√ß√£o`console.log( )` √© usada para imprimir dados de depura√ß√£o. Para gerar instru√ß√µes de log no Evothings Workbench, √© poss√≠vel mapear a fun√ß√£o `console.log` para `hyper.log`, da seguinte maneira:

```
// Redirect console.log to Evothings Workbench.
if (window.hyper && window.hyper.log) { console.log = hyper.log }
```

Os dados do log s√£o enviados na janela do console no Evothings Workbench. Clique no bot√£o "Console" no ambiente de trabalho para abrir esta janela.

## Criando Aplica√ß√µes

### Buscar dispositivos BLE

Aqui est√° um exemplo de c√≥digo completo. Observe que o arquivo `cordova.js` est√° inclu√≠do no plug-in BLE, esse arquivo n√£o faz parte do c√≥digo do aplicativo, √© fornecido como plug-in no Evothings Viewer.

Abaixo o C√≥digo-fonte do arquivo `index.html` e `app.js` (arraste esse arquivo para o Evothings Workbench e clique em RUN para iniciar no Evothings Viewer):

**HTML:** `index.js`

```html
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

	<title>Buscar BLE</title>

	<style>
		@import 'ui/css/evothings-app.css';

		p.deviceAddress {
			margin: 5px 0px 10px 10px;
			font-size: xx-small;
			font-weight:bold;
		}

		p.deviceName {
			margin: 5px 0px 0px 10px;
			font-weight: bold
		}
		p.deviceRssi{
			color:rebeccapurple;
			padding: 2px;
			text-align: center;
		}

		div.deviceContainer {
			border-radius: 10px;
			border: 1px solid;
			border-color: #CCCCCC;
			overflow: hidden;
			margin: 10px 0px;
		}
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>
	
</head>

<body ontouchstart=""><!-- ontouchstart="" enables low-delay CSS transitions. -->

	<header>
		<button class="back" onclick="history.back()">
			<img src="ui/images/arrow-left.svg" />
		</button>

		<img class="logotype" src="ui/images/logo.svg" alt="Evothings" />
	</header>

	<h1>Buscador BLE</h1>

	<div id="startView">
		<button class="red wide" onclick="app.startScan()"> Buscar! </button>
	</div>

	<div id="scanResultView" style="display: none;">
	
	</div>

	<span id="message" style="display: none;">
	</span>

	<script src="cordova.js"></script>
	<script src="libs/evothings/evothings.js"></script>
	<script src="libs/evothings/ui/ui.js"></script>
	<script src="libs/jquery/jquery.js"></script>
	<!-- TODO: Add libraries that you need -->
	<script src="app.js"></script>
</body>
</html>
```



**Javascript:** `app.js`

```javascript
// Iniciar a busca quando o plugin for carregado

document.addEventListener(
    'deviceready',
    function(){ evothings.scriptsLoaded(app.initialize)},
    false
);

var app = {};
var analog_enabled;


app.initialize = function () {
    app.connected = false;
    app.analog_enabled = false;
    app.showMessage('');
}

app.startScan = function(){
    app.disconnect(); 
    app.showMessage('');
    console.log('Scanning started...');
    //lista para dispositivos
    app.devices = {};
    var img = "https://darrenkearney.me/wp-content/uploads/2015/07/hacking_typing1.gif";
    var htmlString = '<p style="display:inline">   Scanning...</p>';
    $('#scanResultView').append($(htmlString));
    $('#scanResultView').show();
    
    evothings.ble.startScan(onScanSuccess,onScanFailure);

    function onScanSuccess(device) {
        if(device.name != null){
            app.devices[device.address] = device;

            //var service = device.advertisementData.;
          
            console.log('Found:'+ JSON.stringify(device));
            
            
            var htmlString =
				'<div class="deviceContainer">' +
				'<p class="deviceName">' + device.name + '</p>' +
                '<p class="deviceAddress">' + device.address + '</p>' +
                '<p class="deviceRssi">' + device.rssi + '</p>' +
				'</div>';

			$('#scanResultView').append( $( htmlString ) );
        }
    }
    function onScanFailure(errorCode) {
        // Show an error message to the user
		app.disconnect('Failed to scan for devices.');

		// Write debug information to console.
		console.log('Error ' + errorCode);
    }
}

app.disconnect = function(errorMessage){
    if (errorMessage)
	{
		console.log(errorMessage);
	}
    
    // Pare a busca
	evothings.ble.stopScan();
    $('#scanResultView').hide();
	$('#scanResultView').empty();
}

app.showMessage = function(message){
    document.querySelector('#message').innerHTML = message;
    $('#message').show();
    //$('#message').hide();
}
```



## Conectando a um dispositivo BLE

Aqui um segundo exemplo de c√≥digo completo. Abaixo o C√≥digo-fonte do arquivo `index.html` e `app.js` (arraste esse arquivo para o Evothings Workbench e clique em RUN para iniciar no Evothings Viewer):

**HTML:** `index.html`

```HTML
<!DOCTYPE html>
<!--
	
	Baseado no BLE example, com algumas atualiza√ß√µes e corre√ß√µes no c√≥digo para trabalhar com o c√≥digo de exemplo do ESP32 para ligar o led padr√£o na porta 25.

-->
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=no,
		shrink-to-fit=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
	<title>ESP32 BLE</title>

	<style>
		@import 'ui/css/evothings-app.css';
	</style>

	<script>
	// Redirect console.log to Evothings Workbench.
	if (window.hyper && window.hyper.log) { console.log = hyper.log }
	</script>

</head>

<body ontouchstart="">
	
  <header>
		<button class="back" onclick="history.back()">
			<img src="ui/images/arrow-left.svg" />
		</button>
		<img class="logotype" src="ui/images/logo.svg" alt="Evothings" />
	</header>
	
	<img class="evo-image" src="https://cdn.apk-cloud.com/detail/image/io.dabbleapp-w250.png"/>
	<h1>ESP32 BLE</h1>
	<button id="find" class="blue">Find Device</button>
	<p><strong>Status:</strong> <span id="message">Idle</span></p>
	<button id="on" class="green">LED ON</button>
	<button id="off" class="red">LED OFF</button>
	
	<!--
	Incluir o cordova.js automaticamente inclui a biblioteca JavaScript para o plugin Cordova BLE.
	-->
	<script src="cordova.js"></script>
	
	<!--
	Inclui o c√≥digo da aplica√ß√£o
	-->
	<script src="app.js"></script>
</body>
</html>

```



**Javascript:** `app.js`

```javascript
// JavaScript code for the Arduino BLE example app.
;(function()
{


var SERVICE_UUID =        		'6E400001-B5A3-F393-E0A9-E50E24DCCA9E'
var CHARACTERISTIC_UUID_RX = 	'6E400002-B5A3-F393-E0A9-E50E24DCCA9E'
var CHARACTERISTIC_UUID_TX = 	'6E400003-B5A3-F393-E0A9-E50E24DCCA9E'


/**
 * The BLE plugin is loaded asynchronously so the ble
 * variable is set in the onDeviceReady handler.
 */
var ble = null;

// Connected device.
var mDevice = null;

var mPollingTimer = null;

var characteristicRead = null;
var characteristicWrite = null;

function btEnable(){
	document.getElementById("on").disabled = false;
	document.getElementById("on").className = 'green';
	document.getElementById("off").disabled = false;
	document.getElementById("off").className = 'red';
}
function btDisable(){
	document.getElementById("on").disabled = true;
	document.getElementById("on").className = 'stone';
	document.getElementById("off").disabled = true;
	document.getElementById("off").className = 'stone';
}
function initialize()
{
	btDisable();

	document.getElementById('find').addEventListener(
		'click',
		findDevice,
		false)
	document.getElementById('on').addEventListener(
		'click',
		on,
		false)
	document.getElementById('off').addEventListener(
		'click',
		off,
		false)

	showMessage('Ready');
	
}

function findDevice()
{
	showMessage('...Finding Device');

	disconnectDevice()

	// Used for debugging/testing.
	scanForDevice();
	return
}

function scanForDevice(){
	showMessage('Scanning device...');

	evothings.ble.startScan(
		onDeviceFound,
		onScanError
	);

	function onDeviceFound(device){
		console.log('Found device: ' + device.name);
		
		if (device.advertisementData.kCBAdvDataLocalName == 'ESP32-SI01'){
			console.log('Found: ' + device.name);

			evothings.ble.stopScan();

			MakeConnection(device);
		}
	}

	function onScanError(){
		console.log('Found device: ' + device.name);
	}
}

function MakeConnection(device){
	showMessage('Connecting to: ' + device.name);
	
	// Save device.
	mDevice = device;
	
	//Biblioteca desatualizada no GTEkViwer
	setTimeout(
		evothings.ble.connectToDevice(
			device,
			onConnected,
			onDisconnected,
			onConnectError
		),
		500
	)

	function onConnected(device){
		console.log('Connected to: ' + device.name);
		getServices(device);
	}

	function onDisconnected(device){
		console.log('Disconnected from: ' + device.name);
	}
	function onConnectError(device){
		console.log('Connect error: ' + device.name);
	}

}

function getServices(device){
	console.log('Getting Services');
	var service = evothings.ble.getService(device, SERVICE_UUID);
	characteristicRead = evothings.ble.getCharacteristic(service,CHARACTERISTIC_UUID_TX);
	characteristicWrite = evothings.ble.getCharacteristic(service,CHARACTERISTIC_UUID_RX);

	if (characteristicRead && characteristicWrite){
		console.log('RX/TX services found.');
		showMessage('READY!');
		btEnable();
	}else{
		showMessage('ERROR: RX/TX services not found!');
		console.log('RX/TX services ERROR.');
	}
}

function disconnectDevice()
{
	evothings.ble.stopScan();
	clearInterval(mPollingTimer);
	if (mDevice) { 
		console.log('Disconnected: ' + mDevice.name);
		evothings.ble.close(mDevice) ;
	}
	mDevice = null;
	btDisable();
	//showMessage('Disconnected');
	
}

function on()
{
	showMessage('ON:');
	writeValue(new TextEncoder("utf-8").encode("1")); 
}

function off()
{
	showMessage('OFF:');
	writeValue(new TextEncoder("utf-8").encode("0"));
}

function writeValue(value){
	evothings.ble.writeCharacteristic(
		mDevice,
		characteristicWrite,
		new Int8Array(value),
		onActivated,
		onActivatedError);
	
	function onActivated()
	{
		console.log('ESP is'+(value==1)?'ON':"OFF");
	}
	
	function onActivatedError(error)
	{
		console.log('ESP32 error: ' + error);
	}
}

function showMessage(text)
{
	document.querySelector('#message').innerHTML = text
	console.log(text)
}

// Start scanning for devices when the plugin has loaded.
document.addEventListener('deviceready', initialize, false)

})(); // End of closure.
```



C√≥digo do ESP32

```java
/*
    Based on Neil Kolban example for IDF: https://github.com/nkolban/esp32-snippets/blob/master/cpp_utils/tests/BLE%20Tests/SampleWrite.cpp
    Ported to Arduino ESP32 by Evandro Copercini
*/
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

#include <iostream>
#include <string.h>

// See the following for generating UUIDs:
// https://www.uuidgenerator.net/

#define SERVICE_UUID        "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_RX "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_TX "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"

BLEServer *pServer = NULL;
BLECharacteristic * pTxCharacteristic;

//Vari√°vel para controlar o LED
const int LED = 25;

//Variaves BLE
bool _BLEClientConnected = false;
bool oldDeviceConnected = false;
uint8_t txValue = 0;
uint8_t rxValue = 0;


class MyCallbacks: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
      
      std::string value = pCharacteristic->getValue();
      
      // put your main code here, to run repeatedly:
      if(value.length() == 1){
        if(value.find("1") != -1){
          digitalWrite(LED, HIGH); // ligar led
        }else{
          digitalWrite(LED, LOW); // desligar led
        }
      }
      if (value.length() > 0) {
        Serial.println("*********");
        Serial.print("New value: ");
        
        for (int i = 0; i < value.length(); i++){
          Serial.print(value[i]);
        }
        Serial.println();
        Serial.println("*********");
      }
    }
};



class MyServerCallbacks : public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
      _BLEClientConnected = true;
      Serial.println("Client Connected");
    };

    void onDisconnect(BLEServer* pServer) {
      _BLEClientConnected = false;
      Serial.println("Client Disconnected");
    }
};

void InitBLE(){
  BLEDevice::init("ESP32-SI01");
  //BLE Server
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());
  
  //BLE Service
  BLEService *pService = pServer->createService(SERVICE_UUID);
  BLECharacteristic *pCharacteristic = pService->createCharacteristic(
                                         CHARACTERISTIC_UUID_RX,
                                         BLECharacteristic::PROPERTY_READ |
                                         BLECharacteristic::PROPERTY_WRITE
                                       );
  pCharacteristic->setCallbacks(new MyCallbacks());
  pCharacteristic->setValue("LED");
  
  //BLE Characteristic
  pTxCharacteristic = pService->createCharacteristic(
										CHARACTERISTIC_UUID_TX,
										BLECharacteristic::PROPERTY_NOTIFY
									);
  pTxCharacteristic->addDescriptor(new BLE2902());
  pService->start();
  BLEAdvertising *pAdvertising = pServer->getAdvertising();
  pAdvertising->start();
}

void setup() {
  Serial.begin(115200);
  pinMode(LED, OUTPUT);
  //Chama a configura√ß√£o inicial do display
  InitBLE();
}

void loop() {
  delay(500);
  if (_BLEClientConnected) {
        pTxCharacteristic->setValue(&txValue, 1);
        pTxCharacteristic->notify();
        txValue++;
		    delay(10); // bluetooth stack will go into congestion, if too many packets are sent
        showInDisplay();
	}
  
  // disconnecting
    if (!_BLEClientConnected && oldDeviceConnected) {
        delay(500); // give the bluetooth stack the chance to get things ready
        pServer->startAdvertising(); // restart advertising
        Serial.println("start advertising");
        oldDeviceConnected = _BLEClientConnected;
    }
    // connecting
    if (_BLEClientConnected && !oldDeviceConnected) {
		// do stuff here on connecting
        oldDeviceConnected = _BLEClientConnected;
    }
}

```



## Extras - informa√ß√µes sobre as fun√ß√µes



#### Procurando por nome e servi√ßo UUID

O primeiro passo ao se comunicar com qualquer dispositivo BLE √© estabelecer uma conex√£o com ele e, para isso, primeiro voc√™ precisa encontrar o dispositivo. Esta etapa √© chamada de escaneamento. Ao procurar dispositivos, voc√™ ter√° todos os dispositivos BLE dentro do alcance. Isso significa que voc√™ deve descobrir de alguma forma a qual dispositivo voc√™ deseja se conectar.

Para determinar a identidade de um dispositivo usando o escaneamento, voc√™ pode usar v√°rios m√©todos. Duas maneiras √∫teis s√£o usar o nome do dispositivo e/ou os UUIDs de servi√ßo anunciados do dispositivo.

Aqui est√° como encontrar a TI SensorTag CC2650 pelo nome:

```javascript
// Start scanning. Two callback functions are specified.
evothings.ble.startScan(
    onDeviceFound,
    onScanError);

// This function is called when a device is detected, here
// we check if we found the device we are looking for.
function onDeviceFound(device)
{
    if (device.advertisementData.kCBAdvDataLocalName == 'CC2650 SensorTag')
    {
        console.log('Found the TI SensorTag!');
    }
}

// Function called when a scan error occurs.
function onScanError(error)
{
    console.log('Scan error: ' + error);
}
```

Em compara√ß√£o, veja como encontrar o dispositivo pelo UUID do servi√ßo anunciado :

```javascript
evothings.ble.startScan(
    onDeviceFound,
    onScanError);

// Here we check for a specific service UUID advertised by the device.
function onDeviceFound(device)
{
    // kCBAdvDataServiceUUIDs is an array of strings with service UUIDs.
    var advertisedServiceUUIDs = device.advertisementData.kCBAdvDataServiceUUIDs;
    if (advertisedServiceUUIDs.indexOf('0000aa10-0000-1000-8000-00805f9b34fb') > -1)
    {
        console.log('Found the TI SensorTag!');
    }
}
```

Voc√™ tamb√©m pode especificar o UUID de servi√ßo no par√¢metro `options` para startScan. Isso instruir√° o sistema BLE nativo a relatar apenas dispositivos que anunciam o UUID de servi√ßo fornecido:

```javascript
// The callback function onDeviceFound will be called only for devices
// that advertise the given service UUID.
evothings.ble.startScan(
    onDeviceFound,
    onScanError,
    { serviceUUIDs: ['0000aa10-0000-1000-8000-00805f9b34fb'] });

function onDeviceFound(device)
{
    console.log('Found the TI SensorTag!');
}
```



### Sele√ß√£o do disposito atrav√©s de uma lista

Para selecionar a qual dispositivo se conectar √© importante exibir uma lista com os dispositivos e seus nomes. Dessa forma, o usu√°rio do aplicativo pode selecione manualmente um dispositivo. 

> ‚òïÔ∏é A lista pode ser constru√≠da dinamicamente durante o escanemanto, sendo atualizada e classificada por informa√ß√µes como a dist√¢ncia ou valor do RSSI.

### Sele√ß√£o do dispositivo pelos dados do an√∫ncio

Os UUIDs de servi√ßo anunciado (**kCBAdvDataServiceUUIDs**) usados acima fazem parte dos dados do an√∫ncio do BLE. Este √© um bloco de bytes que √© transmitido por um dispositivo BLE quando est√° no modo de an√∫ncio. √â importante consultar a documenta√ß√£o dos dados do an√∫ncio para obter uma lista dos campos dispon√≠veis (esses campos podem estar indefinidos ou vazios, dependendo do dispositivo BLE).

Em alguns casos um dispositivo n√£o pode ser identificado exclusivamente por seu nome e/ou UUIDs de servi√ßo anunciados. Dependendo do dispositivo, pode haver outros dados no an√∫ncio que possam ser usados para identific√°-lo. Os sinalizadores de Eddystone, por exemplo, transmitem IDs e URLs como parte dos dados do an√∫ncio.

Aqui est√° como gerar uma representa√ß√£o imprim√≠vel da estrutura de dados do an√∫ncio:

```javascript
function onDeviceFound(device)
{
    console.log('Found device:' + JSON.stringify(device.advertisementData));
}
You can also print the entire device structure:

function onDeviceFound(device)
{
    console.log('Found device:' + JSON.stringify(device));
}
```

### Conectando-se a um dispositivo

Quando o dispositivo for encontrado, o pr√≥ximo passo √© conectar-se a ele. Normalmente, a verifica√ß√£o est√° agora parada e a fun√ß√£o de conex√£o √© chamada. Aqui est√° um exemplo:

```javascript
evothings.ble.startScan(
    onDeviceFound,
    onScanError);

// This function is called when a device is detected, here
// we check if we found the device we are looking for.
function onDeviceFound(device)
{
    if (device.advertisementData.kCBAdvDataLocalName == 'CC2650 SensorTag')
    {
        // Stop scanning.
        evothings.ble.stopScan();

        // Connect.
        evothings.ble.connectToDevice(
            device,
            onConnected,
            onDisconnected,
            onConnectError);
    }
}

// Called when device is connected.
function onConnected(device)
{
    console.log('Connected to device');
}

// Called if device disconnects.
function onDisconnected(device)
{
    console.log('Disconnected from device');
}

// Called when a connect error occurs.
function onConnectError(error)
{
    console.log('Connect error: ' + error);
}
```

Por padr√£o, a fun√ß√£o `evothings.ble.connectToDevice` l√™ todos os servi√ßos, caracter√≠sticas e descritores do dispositivo. Opcionalmente, voc√™ pode especificar os servi√ßos a serem lidos (a leitura apenas dos servi√ßos necess√°rios pode melhorar o desempenho):

```javascript
evothings.ble.connectToDevice(
    device,
    onConnected,
    onDisconnected,
    onConnectError)
    { serviceUUIDs: ['f000aa70-0451-4000-b000-000000000000'] })
```

### Lendo e gravando caracter√≠sticas

As caracter√≠sticas s√£o como comandos ou fun√ß√µes, elas podem ser lidas para obter dados ou escritas para controlar algum aspecto de um dispositivo. Por exemplo, no TI SensorTag, voc√™ liga e desliga um sensor gravando em uma caracter√≠stica. Quando o sensor est√° ligado, voc√™ pode ler dados de outra caracter√≠stica. Ambas as caracter√≠sticas fazem parte do mesmo servi√ßo.

Use as fun√ß√µes `evothings.ble.getService` e `evothings.ble.getCharacteristic` para obter a caracter√≠stica que voc√™ deseja ler e escrever. Para ler e escrever descritores, use a fun√ß√£o `evothings.ble.getDescriptor` para fazer com que o descritor escreva/leia.

Aqui est√° um exemplo de como gravar e ler uma caracter√≠stica:

```javascript
// UUID of service.
var BLE_SERVICE = 'f000aa70-0451-4000-b000-000000000000'

// UUID of config characteristic (write 1 to turn sensor ON, 0 to turn OFF).
var BLE_CONFIG = 'f000aa72-0451-4000-b000-000000000000'

// UUID of data characteristic.
var BLE_DATA = 'f000aa71-0451-4000-b000-000000000000'

// Get service and characteristics.
var service = evothings.ble.getService(device, BLE_SERVICE)
var configCharacteristic = evothings.ble.getCharacteristic(service, BLE_CONFIG)
var dataCharacteristic = evothings.ble.getCharacteristic(service, BLE_DATA)

// Write a charateristic.
evothings.ble.writeCharacteristic(
    device,
    configCharacteristic,
    new Uint8Array([1]), //new TextEncoder("utf-8").encode("1")
    onCharacteristicActivated,
    onCharacteristicActivatedError)

function onCharacteristicActivated()
{
    console.log('Characteristic is ON')

    // Enable notifications from the Luxometer.
    evothings.ble.readCharacteristic(
        device,
        dataCharacteristic,
        onCharacteristicRead,
        onCharacteristicReadError)
}

function onCharacteristicActivatedError(error)
{
    console.log('Characteristic activate error: ' + error)
}

function onCharacteristicRead(data)
{
    // Get raw sensor value (data buffer has little endian format).
    var raw = new DataView(data).getUint16(0, true)
    console.log('Raw Characteristic value: ' + raw)
}

function onCharacteristicReadError(error)
{
    console.log('Read Characteristic error: ' + error)
}
```



### Usando notifica√ß√µes para ler dados

√â comum que um aplicativo precise ler continuamente dados de um dispositivo BLE. Os exemplos incluem a **leitura** de um sensor e o **envio** de dados para a nuvem ou o uso do aceler√¥metro de um dispositivo sensor para controlar um jogo no celular.

As **notifica√ß√µes** s√£o uma maneira eficiente de ler dados continuamente de um dispositivo BLE. O processo √© semelhante √† leitura de dados, a principal diferen√ßa √© que a fun√ß√£o de retorno de chamada ser√° chamada repetidamente at√© que a notifica√ß√£o seja desativada.

Aqui est√° um exemplo de c√≥digo de como habilitar e manipular notifica√ß√µes:

```javascript
function onCharacteristicActivated()
{
    console.log('Characteristic is ON')

    // Enable notifications from the Luxometer.
    evothings.ble.enableNotification(
        device,
        dataCharacteristic,
        onCharacteristicNotification,
        onCharacteristicNotificationError)
}

// Called repeatedly until disableNotification is called.
function onCharacteristicNotification(data)
{
    console.log('Characteristic value: ' + data)
}

function onCharacteristicNotificationError(error)
{
    console.log('Characteristic notification error: ' + error)
}
```



## Aplica√ß√µes de Exemplo

- Localizar Objetos BLE - Criar uma aplica√ß√£o para ler a intensidade do RSSI e conforme reduz a dist√¢ncia mais o led pisca na tela (blink) do aplicativo.
- https://evothings.com/how-to-connect-your-phone-to-your-esp8266-module/ (ESP8266 WiFi)
- https://evothings.com/diy-arduino-beacons/ (Fazer com ESP32I)
- Pensar em uma aplica√ß√£o apenas para trocar dados entre celulares
  - Beacon Chat
- https://evothings.com/arduino-ble-quick-walk-through/

## Problemas com Codifica√ß√£o

Ao escrever a caracter√≠stica o valor passado n√£o estava sendo recebido com a codifica√ß√£o correta pelo ESP. Abaixo s√£o descritas duas formas, uma que funciona para a vers√£o do GTekViewer, que roda no iOS, e outra para o Evothings Viewer, que roda no android.

Para Android:

```javascript
writeValue(new TextEncoder("utf-8").encode("0"));
```

Para iOS:

```javascript
app.toUTF8Array = function(str) {
    var utf8 = [];
    for (var i=0; i < str.length; i++) {
        var charcode = str.charCodeAt(i);
        if (charcode < 0x80) utf8.push(charcode);
        else if (charcode < 0x800) {
            utf8.push(0xc0 | (charcode >> 6), 
                      0x80 | (charcode & 0x3f));
        }
        else if (charcode < 0xd800 || charcode >= 0xe000) {
            utf8.push(0xe0 | (charcode >> 12), 
                      0x80 | ((charcode>>6) & 0x3f), 
                      0x80 | (charcode & 0x3f));
        }
        // surrogate pair
        else {
            i++;
            charcode = ((charcode&0x3ff)<<10)|(str.charCodeAt(i)&0x3ff)
            utf8.push(0xf0 | (charcode >>18), 
                      0x80 | ((charcode>>12) & 0x3f), 
                      0x80 | ((charcode>>6) & 0x3f), 
                      0x80 | (charcode & 0x3f));
        }
    }
    return utf8;
};

var data = app.toUTF8Array("1");
    app.device && app.device.writeDataArray(new Uint8Array([data]), '6E400002-B5A3-F393-E0A9-E50E24DCCA9E');
```

## Refer√™ncias

https://evothings.com/doc/build/build-overview.html

https://evothings.com/doc/build/cordova-guide.html#SummaryOfBuildSteps

https://evothings.com/doc/starter-guides/cordova-starter-guide.html